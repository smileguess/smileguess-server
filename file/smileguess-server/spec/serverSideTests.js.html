<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">smileguess-server/spec/serverSideTests.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">collections</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/collections/Games.js~Games.html">Games</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/collections/Users.js~Users.html">Users</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/models/Game.js~Game.html">Game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/models/User.js~User.html">User</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sockets</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dummy">dummy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onConnect">onConnect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onDisconnect">onDisconnect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendClueMessage">sendClueMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendGuessMessage">sendGuessMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendPlayerJoinGame">sendPlayerJoinGame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendPrompt">sendPrompt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendWinner">sendWinner</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">smileguess-server/spec/serverSideTests.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const reporter = require(&apos;./support/reporter&apos;);
const request = require(&apos;request&apos;);
const User = require(&apos;../models/User&apos;);
const Users = require(&apos;../collections/Users&apos;);
const Games = require(&apos;../collections/Games.js&apos;);
const GameController = require(&apos;../controllers/GameController&apos;);
const UserController = require(&apos;../controllers/UserController&apos;);
const settings = require(&apos;../gameSettings&apos;);
const testUtils = require(&apos;./testUtils&apos;);
const express = require(&apos;express&apos;);
const app = express();
const server = require(&apos;http&apos;).createServer(app);
const ioCreate = require(&apos;socket.io&apos;);
jasmine.getEnv().addReporter(reporter);

const serverURL = &apos;http://127.0.0.1:1234&apos;;
const joinOrStartGameURL = &apos;http://127.0.0.1:1234/api/game/&apos;;

let testDb = {
  games: new Games(ioCreate.listen(server)),
  users: new Users(),
};

describe(&apos;Server Functions&apos;, () =&gt; {
  describe(&apos;API&apos;, () =&gt; {
    it(&apos;will respond to a request at a nonexistant endpoint&apos;, (done) =&gt; {
      const options = {
        method: &apos;GET&apos;,
        uri: serverURL,
      };
      request(options, (error, res) =&gt; {
        if (error &amp;&amp; error.code === &apos;ECONNREFUSED&apos;) {
          throw new Error(&apos;Connection refused, are you sure your server is running?&apos;);
        }
        expect(res.statusCode).toBe(404);
        done();
      });
    });
    it(&apos;will respond with a game instance&apos;, (done) =&gt; {
      testUtils.sendPlayRequest(null, (err, res, body) =&gt; {
        const game = JSON.parse(body);
        expect(game.hasOwnProperty(&apos;id&apos;)).toBe(true);
        expect(game.hasOwnProperty(&apos;players&apos;)).toBe(true);
        done();
      });
    });
  });
});

describe(&apos;Models, Collections and Controllers: &apos;, () =&gt; {
  beforeEach(() =&gt; {
    testDb = {
      games: new Games(ioCreate.listen(server)),
      users: new Users(),
    };
  });

  describe(&apos;User Model&apos;, () =&gt; {
    it(&apos;will correctly instantiate a new user&apos;, () =&gt; {
      expect(testDb.users.createUser(&apos;hypotheticalDeviceId&apos;).userId).toBe(1);
      expect(UserController.getUser(testDb.users, 1).username).not.toBe(undefined);
    });
  });

  describe(&apos;Game Model&apos;, () =&gt; {
    it(&apos;will correctly instantiate a new game&apos;, () =&gt; {
      testDb.games.createGame();
      expect(testDb.games.getNextOpenGame().hasOwnProperty(&apos;id&apos;)).toBe(true);
      expect(testDb.games.getNextOpenGame().hasOwnProperty(&apos;players&apos;)).toBe(true);
      expect(testDb.games.getNextOpenGame().hasOwnProperty(&apos;seatsOpen&apos;)).toBe(true);
      expect(testDb.games.getNextOpenGame().hasOwnProperty(&apos;dealerId&apos;)).toBe(true);
      expect(testDb.games.getNextOpenGame().hasOwnProperty(&apos;events&apos;)).toBe(true);
    });

    it(&apos;will place a player in a game&apos;, () =&gt; {
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, 2)
      console.log(testDb.games.getNextOpenGame().players.all[&apos;1&apos;].userId);
      expect(testDb.games.getNextOpenGame().players.byId[0]).toEqual(1);
      expect(testDb.games.getNextOpenGame().players.all[&apos;1&apos;].userId).toEqual(1);
      expect(testDb.games.getNextOpenGame().players.byId[1]).toEqual(2);
      expect(testDb.games.getNextOpenGame().players.all[&apos;2&apos;].userId).toEqual(2)
    });
    it(&apos;will remove a player from a game&apos;, () =&gt; {
      const testGame = testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, 2)
      expect(testGame.players.byId.length).toEqual(2);
      expect(Object.keys(testGame.players.all).length).toEqual(2);


      GameController.handlePlayerLeave(testDb.games, 1, 1);
      expect(testGame.players.byId.length).toBe(1);
      expect(Object.keys(testGame.players.all).length).toEqual(1);

    });
    it(&apos;will adjust the number of seats available after adding players&apos;, () =&gt; {
      const testGame = testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, 1);
      expect(testGame.seatsOpen).toEqual(settings.maxPlayers - 1);

      testUtils.populateNextOpenGameWithPlayers(testDb, 1);
      expect(testGame.seatsOpen).toEqual(settings.maxPlayers - testGame.players.byId.length);
    });
    it(&apos;will adjust the number of seats available after removing players&apos;, () =&gt; {
      const testGame = testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, 2);
      expect(testGame.seatsOpen).toEqual(settings.maxPlayers - 2);

      GameController.handlePlayerLeave(testDb.games, 1, 2);
      expect(testGame.seatsOpen).toEqual(settings.maxPlayers - 1);
    });
    it(&apos;will start a game after enough players have joined&apos;, () =&gt; {
      const testGame = testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.minPlayers - 1);
      expect(testDb.games.getNextOpenGame().active).toBe(false);

      testUtils.populateNextOpenGameWithPlayers(testDb, 1);
      expect(testDb.games.getNextOpenGame().active).toBe(true);
    });
    it(&apos;will assign the first dealer&apos;, () =&gt; {
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.minPlayers);
      expect(testDb.games.openGames[0].dealer).not.toBe(null);
    });
    it(&apos;will assign a random prompt from a random category&apos;, () =&gt; {
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.minPlayers);
      expect(testDb.games.retrieve(1).prompt.forDisplay).not.toBe(null);
      expect(testDb.games.retrieve(1).prompt.forMatching).not.toBe(null);
    });
    it(&apos;will check guesses&apos;, () =&gt; {
      const testGuess = {
        type: &apos;SOCKET_GUESS_MESSAGE&apos;,
        userid: &apos;user1ID&apos;,
        message: &apos;NOT A CORRECT GUESS&apos;,
      };
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.minPlayers);
      expect(GameController.handleGuess(testDb.games, 1, testGuess.message)).toBe(false);

      prompt = testDb.games.getNextOpenGame().prompt.forMatching.toLowerCase();
      console.log(prompt);
      expect(GameController.handleGuess(testDb.games, 1, prompt)).not.toBe(false);
    });
  });

  describe(&apos;Game Collection&apos;, () =&gt; {
    it(&apos;will retrieve a game by game id&apos;, () =&gt; {
      testDb.games.createGame();
      expect(testDb.games.retrieve(1)).not.toBe(undefined);
    });
    it(&apos;will quarantine full games&apos;, () =&gt; {
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.maxPlayers - 1);
      expect(testDb.games.fullGames.length).toEqual(0);

      GameController.handlePlayerJoin(testDb.games, testUtils.generateTestUsers(testDb.users, 1)[0].userId);
      expect(testDb.games.fullGames.length).toEqual(1);
    });
    it(&apos;will aggregate games with seats available&apos;, () =&gt; {
      testDb.games.createGame();
      testDb.games.createGame();
      expect(testDb.games.openGames.length).toEqual(2);
    });
    it(&apos;will move games from openGames to fullGames when they are full&apos;, () =&gt; {
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.maxPlayers - 1);
      expect(testDb.games.fullGames.length).toEqual(0);
      GameController.handlePlayerJoin(testDb.games, testUtils.generateTestUsers(testDb.users, 1)[0].userId);
      expect(testDb.games.fullGames.length).toEqual(1);
      expect(testDb.games.openGames.length).toEqual(0);
    });
    it(&apos;will move games from fullGames to openGames when a seat becomes available&apos;, () =&gt; {
      testDb.games.createGame();
      expect(testDb.games.fullGames.length).toEqual(0);
      testUtils.populateNextOpenGameWithPlayers(testDb, settings.maxPlayers);
      expect(testDb.games.fullGames.length).toEqual(1);
    });
    it(&apos;will order open games by number of seats available&apos;, () =&gt; {
      testDb.games.createGame();
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, 3);

      expect(testDb.games.retrieve(testDb.games.openGames[0]).seatsOpen).toEqual(4);
      expect(testDb.games.retrieve(testDb.games.openGames[1]).seatsOpen).toEqual(5);
    });
    it(&apos;will place users in the game with the most seats available&apos;, () =&gt; {
      testDb.games.createGame();
      testDb.games.createGame();
      testUtils.populateNextOpenGameWithPlayers(testDb, 4);
      expect(testDb.games.openGames[0][1]).toEqual(testDb.games.openGames[1][1]);
    });
    it(&apos;will create a new game if no seats are available&apos;, () =&gt; {
      GameController.play(testDb.games, (game) =&gt; {
        testUtils.populateNextOpenGameWithPlayers(testDb, 1);
        expect(game.players.byId[0]).toEqual(1);
      });
    });
    it(&apos;will destroy the game if all players leave&apos;, () =&gt; {
      testDb.games.createGame();
      expect(testDb.games.openGames.length).toEqual(1);
      expect(typeof testDb.games.retrieve(testDb.games.openGames[0])).toBe(&apos;object&apos;);
      GameController.handlePlayerLeave(testDb.games, 1, 1);
      expect(testDb.games.openGames.length).toEqual(0);
      expect(testDb.games.retrieve(testDb.games.openGames[0])).toBe(undefined);
    });
  });
});

module.exports = {

};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
