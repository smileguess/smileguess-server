<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">smileguess-server/models/Game.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">collections</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/collections/Games.js~Games.html">Games</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/collections/Users.js~Users.html">Users</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/models/Game.js~Game.html">Game</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/smileguess-server/models/User.js~User.html">User</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">sockets</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-dummy">dummy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onConnect">onConnect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onDisconnect">onDisconnect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendClueMessage">sendClueMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendGuessMessage">sendGuessMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendPlayerJoinGame">sendPlayerJoinGame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendPrompt">sendPrompt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-sendWinner">sendWinner</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">smileguess-server/models/Game.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const settings = require(&apos;../config/gameSettings&apos;);
const utils = require(&apos;../controllers/utils&apos;);
const solutions = require(&apos;../config/solutions&apos;);
const random = utils.getRandomIntInclusive;

/**
 * The Game model persists data about a single game room, including players, dealer
 * and other state information. Should be instantiated when a brand new game room is
 * created, otherwise retrieved from the Games collection.
 * @example
 * const newGame = new Game(gameId, io);
 */
class Game {
  /**
   * Constructor to instantiate a new Game instance.
   * @param {number} gameId - the identifer of the new game
   * @param {object} io - the socket connection pre-limited to the game&apos;s id via io.to(gameId)
   */
  constructor(gameId, io) {
    /**
    * Game identifier
    * @type {number}
    */
    this.id = gameId;

    /**
     * Collection of user instances in the game.  This has an `all` attribute with all the players in a hash table keyed by id, and an `byId` attribute with all the players&apos; ids in an array.
     * @type {object[ ]}
     */
    this.players = {
      all: {},
      byId: [],
    };

    /**
    * Current number of available seats in the game
    * @type {number}
    */
    this.seatsOpen = settings.maxPlayers;

    /**
    * Specifies which player is currently creating clues with emojis
    * @type {object}
    */
    this.dealerId = null;

    /**
    * Defines the prompt that the &quot;dealer&quot; must communicate via emojis
    * @type {object}
    */
    this.prompt = {
      /**
      * @property {string} prompt.category Communicates the solution&apos;s category to all players
      */
      category: null,

      /**
       * @property {string} prompt.forDisplay Communicates the prompt to the dealer
       */
      forDisplay: null,

      /**
       * @property {string} prompt.forMatching Prevents correct answers from being deemed incorrect due to capitilization, spacing, special characters, etc.
       */
      forMatching: null,
    };
    /**
    * Prevents the game from running until sufficient players have joined
    * @type {boolean}
    */
    this.active = false;
    /**
    * Event listener callback functions to be invoked
    * @type {array}
    */
    this.events = [];

    /**
     * The io object used for sending socket messages to this game
     * @type {object}
     */
    this.io = io.to(this.id);

  }
  /**
   * Adds event listeners
   * @param {string} event - an event name
   * @param {function} gameId - a function to invoke upon an event
   */
  on(event, ...args) {
    this.events[event] = this.events[event] || [];
    args.forEach(callback =&gt; this.events[event].push(callback));
  }

  /**
   * Triggers a callback associated with a given event
   * @param {string} - an event name
   */
  trigger(event, ...args) {
    if (this.events[event]) {
      this.events[event].forEach(callback =&gt; callback.apply(null, args));
    }
  }

  /**
   * Modifies the number of available seats in the game
   */
  updateOpenSeats() {
    const wasFull = this.seatsOpen === 0;
    const gameId = this.id;
    this.seatsOpen = settings.maxPlayers - this.players.byId.length;
    this.trigger(&apos;playerChange&apos;, &apos;playerChange&apos;, this);
    if (this.seatsOpen === 0) {
      return this.trigger(&apos;full&apos;, gameId);
    }
    if (this.seatsOpen === settings.maxPlayers) {
      return this.trigger(&apos;empty&apos;, gameId);
    }
    if (wasFull &amp;&amp; this.seatsOpen &gt; 0) {
      return this.trigger(&apos;nowAvailable&apos;, gameId, this.seatsOpen);
    }
    return null;
  }

  /**
   * Removes a player from the game
   * @params {number} - a user ID
   */
  removePlayer(userId) {
    this.players.byId.splice(this.players.byId.indexOf(userId), 1);
    delete this.players.all[userId];
    this.updateOpenSeats();
    if (this.players.byId.length &lt; settings.minPlayers) {
      this.active = false;
    }
    return this;
  }

  /**
   * Adds a player to the game
   * @params {object} - a user model
   */
  addPlayer(user) {
    if (this.players.byId.length &lt; settings.maxPlayers) {
      this.players.byId.push(user.userId);
      this.players.all[user.userId] = user;
    } else {
      console.log(&apos;Error: Game full&apos;);
    }
    this.updateOpenSeats();
    if (!this.active &amp;&amp; this.players.byId.length &gt;= settings.minPlayers) {
      this.active = true;
      this.trigger(&apos;activityStatus&apos;, &apos;activityStatus&apos;, this);
      this.newDealer();
      this.getPrompt();
    }
    return this;
  }

  /**
   * Randomly chooses a world or phrase to be guessed
   */
  getPrompt() {
    const categoryNumber = random(0, solutions.solutionsForDisplay.length - 1);
    const solutionNumber = random(0, solutions.solutionsForDisplay[categoryNumber].length - 1);
    this.prompt.forDisplay = solutions.solutionsForDisplay[categoryNumber][solutionNumber];
    this.prompt.forMatching = solutions.simplifiedSolutions[categoryNumber][solutionNumber];
    this.trigger(&apos;newPrompt&apos;, &apos;newPrompt&apos;, this);
  }

  /**
   * Checks messages for correct guesses
   * @params {object} - an object containing a message and a reference to the sender
   */
  checkGuess(message) {
    if (utils.simplifyString(message) === this.prompt.forMatching) {
      return this.newDealer(message.userId);
    }
    return false;
  }

  /**
   * Assigns the next dealer as the correct guesser
   * @params {string} - the user id of the next dealer
   */
  newDealer(userId) {
    this.dealerId = userId || this.players[random(1, this.players.length) - 1];
    this.trigger(&apos;newDealer&apos;, &apos;newDealer&apos;, this);
    this.getPrompt();
    return this.dealerId;
  }
};

module.exports = Game;

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
